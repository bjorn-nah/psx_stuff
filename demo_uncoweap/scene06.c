#include <stdint.h>
#include <stdio.h>
#include <psxgpu.h>
#include <psxgte.h>
#include <inline_c.h>
#include "disp.h"
#include "modplayer.h"
#include "3dStuff.h"

SVECTOR vader_verts[] = {
{-131, 118, 95, 0},
{-200, 0, 0, 0},
{-162, 0, 118, 0},
{50, 118, -154, 0},
{19, 190, -59, 0},
{131, 118, -95, 0},
{200, 0, 0, 0},
{162, 118, 0, 0},
{62, 0, -190, 0},
{-50, 118, -154, 0},
{-62, 0, -190, 0},
{162, 0, -118, 0},
{-162, 0, -118, 0},
{-131, 118, -95, 0},
{50, 190, -36, 0},
{62, 190, 0, 0},
{-62, 190, 0, 0},
{-162, 118, 0, 0},
{-50, 118, 154, 0},
{-62, 0, 190, 0},
{131, 118, 95, 0},
{62, 0, 190, 0},
{162, 0, 118, 0},
{-19, 190, -59, 0},
{19, 190, 59, 0},
{50, 118, 154, 0},
{-50, 190, 36, 0},
{-19, 190, 59, 0},
{50, 190, 36, 0},
{-50, 190, -36, 0},
{227, -200, -165, 0},
{280, -200, 0, 0},
{-280, -200, 0, 0},
{-110, -200, 45, 0},
{-162, -200, 82, 0},
{162, -200, 82, 0},
{227, -200, 165, 0},
{196, -200, 187, 0},
{110, -200, 45, 0},
{110, -200, -73, 0},
{87, -200, -266, 0},
{-87, -200, -266, 0},
{-110, -200, -73, 0},
{-227, -200, 165, 0},
{-196, -200, 187, 0},
{-227, -200, -165, 0},
{-66, -15, 194, 0},
{-63, -12, 195, 0},
{-89, -33, 186, 0},
{-188, -179, 183, 0},
{-169, -130, 174, 0},
{-60, -10, 194, 0},
{60, -10, 194, 0},
{63, -12, 195, 0},
{66, -15, 194, 0},
{89, -33, 186, 0},
{188, -179, 183, 0},
{169, -130, 174, 0},
{-150, -82, 165, 0},
{150, -82, 165, 0},
{54, -32, 130, 0},
{24, -21, 127, 0},
{52, -34, 127, 0},
{19, -10, 141, 0},
{50, -10, 164, 0},
{63, -26, 147, 0},
{73, -31, 147, 0},
{101, -51, 147, 0},
{160, -131, 147, 0},
{144, -82, 147, 0},
{160, -132, 145, 0},
{126, -168, 69, 0},
{149, -151, 92, 0},
{155, -147, 114, 0},
{-126, -168, 69, 0},
{-149, -151, 92, 0},
{-155, -147, 114, 0},
{-160, -132, 145, 0},
{-19, -10, 141, 0},
{-50, -10, 164, 0},
{-73, -31, 147, 0},
{-101, -51, 147, 0},
{-144, -82, 147, 0},
{-160, -131, 147, 0},
{-24, -21, 127, 0},
{-54, -32, 130, 0},
{-63, -26, 147, 0},
{-52, -34, 127, 0},
{-25, -53, 147, 0},
{-10, -100, 127, 0},
{-25, -53, 127, 0},
{-10, -100, 147, 0},
{-115, -176, 147, 0},
{-65, -176, 127, 0},
{-65, -176, 147, 0},
{-115, -176, 127, 0},
{-155, -147, 147, 0},
{-25, -147, 147, 0},
{-25, -147, 127, 0},
{-126, -168, 127, 0},
{25, -147, 147, 0},
{10, -100, 127, 0},
{25, -147, 127, 0},
{10, -100, 147, 0},
{25, -53, 127, 0},
{25, -53, 147, 0},
{126, -168, 127, 0},
{155, -147, 147, 0},
{115, -176, 147, 0},
{115, -176, 127, 0},
{65, -176, 127, 0},
{65, -176, 147, 0},
{-80, -260, 187, 0},
{80, -260, 127, 0},
{80, -260, 187, 0},
{-80, -260, 127, 0},
{0, -140, 187, 0},
{0, -140, 127, 0},
{-80, -260, -73, 0},
{80, -260, -73, 0},
{240, -420, -73, 0},
{240, -420, 127, 0},
{-240, -420, 127, 0},
{-240, -420, -73, 0},
};

/* Cube vertex indices */
INDEX vader_indices[] = {
{1, 0, 2, 0},
{4, 3, 5, 0},
{5, 6, 7, 0},
{9, 8, 3, 0},
{8, 9, 10, 0},
{5, 11, 6, 0},
{8, 11, 5, 0},
{1, 12, 13, 0},
{4, 5, 14, 0},
{14, 5, 15, 0},
{17, 16, 0, 0},
{0, 18, 19, 0},
{21, 20, 22, 0},
{15, 5, 7, 0},
{3, 8, 5, 0},
{12, 10, 13, 0},
{23, 3, 4, 0},
{3, 23, 9, 0},
{24, 20, 25, 0},
{25, 20, 21, 0},
{13, 9, 23, 0},
{17, 13, 16, 0},
{25, 19, 18, 0},
{19, 25, 21, 0},
{20, 6, 22, 0},
{2, 0, 19, 0},
{20, 7, 6, 0},
{15, 7, 20, 0},
{13, 10, 9, 0},
{0, 16, 26, 0},
{0, 27, 18, 0},
{25, 27, 24, 0},
{27, 25, 18, 0},
{24, 28, 20, 0},
{28, 15, 20, 0},
{1, 13, 17, 0},
{1, 17, 0, 0},
{13, 29, 16, 0},
{0, 26, 27, 0},
{28, 14, 15, 0},
{28, 4, 14, 0},
{24, 4, 28, 0},
{24, 23, 4, 0},
{27, 23, 24, 0},
{27, 29, 23, 0},
{26, 29, 27, 0},
{29, 26, 16, 0},
{13, 23, 29, 0},
{6, 30, 31, 0},
{33, 32, 34, 0},
{31, 35, 36, 0},
{36, 35, 37, 0},
{31, 38, 35, 0},
{38, 31, 39, 0},
{39, 31, 30, 0},
{40, 39, 30, 0},
{41, 39, 40, 0},
{41, 42, 39, 0},
{32, 33, 42, 0},
{34, 43, 44, 0},
{43, 34, 32, 0},
{45, 42, 41, 0},
{32, 42, 45, 0},
{46, 19, 47, 0},
{19, 46, 48, 0},
{49, 43, 50, 0},
{43, 49, 44, 0},
{8, 30, 11, 0},
{51, 19, 21, 0},
{19, 51, 47, 0},
{21, 52, 51, 0},
{52, 21, 53, 0},
{45, 41, 10, 0},
{10, 40, 8, 0},
{40, 10, 41, 0},
{8, 40, 30, 0},
{11, 30, 6, 0},
{45, 10, 12, 0},
{32, 45, 1, 0},
{21, 54, 53, 0},
{54, 21, 55, 0},
{56, 36, 37, 0},
{36, 56, 57, 0},
{32, 1, 43, 0},
{45, 12, 1, 0},
{43, 1, 2, 0},
{48, 2, 19, 0},
{58, 2, 48, 0},
{50, 2, 58, 0},
{2, 50, 43, 0},
{6, 31, 36, 0},
{22, 55, 21, 0},
{22, 59, 55, 0},
{22, 57, 59, 0},
{57, 22, 36, 0},
{22, 6, 36, 0},
{61, 60, 62, 0},
{60, 61, 63, 0},
{65, 64, 66, 0},
{60, 64, 65, 0},
{64, 60, 63, 0},
{66, 54, 67, 0},
{54, 52, 53, 0},
{52, 54, 64, 0},
{64, 54, 66, 0},
{59, 68, 69, 0},
{57, 68, 59, 0},
{68, 56, 70, 0},
{56, 68, 57, 0},
{67, 59, 69, 0},
{67, 55, 59, 0},
{55, 67, 54, 0},
{71, 35, 38, 0},
{35, 71, 72, 0},
{73, 35, 72, 0},
{73, 56, 35, 0},
{56, 73, 70, 0},
{35, 56, 37, 0},
{74, 34, 75, 0},
{34, 74, 33, 0},
{34, 76, 75, 0},
{76, 49, 77, 0},
{49, 76, 34, 0},
{49, 34, 44, 0},
{63, 52, 64, 0},
{78, 52, 63, 0},
{78, 51, 52, 0},
{51, 78, 79, 0},
{51, 46, 47, 0},
{46, 51, 79, 0},
{80, 46, 79, 0},
{46, 80, 81, 0},
{58, 82, 83, 0},
{83, 50, 58, 0},
{83, 49, 50, 0},
{49, 83, 77, 0},
{61, 78, 63, 0},
{78, 61, 84, 0},
{81, 48, 46, 0},
{81, 58, 48, 0},
{58, 81, 82, 0},
{85, 79, 78, 0},
{86, 79, 85, 0},
{79, 86, 80, 0},
{84, 85, 78, 0},
{85, 84, 87, 0},
{89, 88, 90, 0},
{88, 89, 91, 0},
{93, 92, 94, 0},
{92, 93, 95, 0},
{90, 85, 87, 0},
{85, 90, 88, 0},
{85, 88, 86, 0},
{80, 88, 81, 0},
{88, 80, 86, 0},
{81, 94, 82, 0},
{91, 81, 88, 0},
{82, 92, 83, 0},
{83, 92, 96, 0},
{97, 81, 91, 0},
{92, 82, 94, 0},
{94, 81, 97, 0},
{98, 94, 97, 0},
{94, 98, 93, 0},
{98, 91, 89, 0},
{91, 98, 97, 0},
{99, 92, 95, 0},
{75, 99, 74, 0},
{99, 96, 92, 0},
{96, 99, 76, 0},
{76, 99, 75, 0},
{77, 96, 76, 0},
{96, 77, 83, 0},
{101, 100, 102, 0},
{100, 101, 103, 0},
{60, 104, 62, 0},
{60, 105, 104, 0},
{105, 60, 65, 0},
{73, 106, 107, 0},
{106, 73, 72, 0},
{106, 108, 107, 0},
{108, 106, 109, 0},
{106, 72, 71, 0},
{110, 100, 111, 0},
{100, 110, 102, 0},
{104, 103, 101, 0},
{103, 104, 105, 0},
{66, 105, 65, 0},
{105, 66, 67, 0},
{67, 103, 105, 0},
{67, 100, 103, 0},
{67, 111, 100, 0},
{111, 67, 69, 0},
{69, 108, 111, 0},
{108, 69, 68, 0},
{108, 68, 107, 0},
{70, 107, 68, 0},
{107, 70, 73, 0},
{109, 111, 108, 0},
{111, 109, 110, 0},
{113, 112, 114, 0},
{112, 113, 115, 0},
{113, 116, 117, 0},
{116, 113, 114, 0},
{112, 116, 114, 0},
{117, 112, 115, 0},
{112, 117, 116, 0},
{33, 118, 42, 0},
{33, 115, 118, 0},
{74, 115, 33, 0},
{115, 74, 99, 0},
{119, 38, 39, 0},
{38, 106, 71, 0},
{38, 113, 106, 0},
{113, 38, 119, 0},
{42, 119, 39, 0},
{119, 42, 118, 0},
{115, 95, 93, 0},
{95, 115, 99, 0},
{84, 90, 87, 0},
{90, 84, 61, 0},
{61, 104, 90, 0},
{104, 61, 62, 0},
{104, 89, 90, 0},
{101, 89, 104, 0},
{117, 89, 101, 0},
{117, 98, 89, 0},
{98, 115, 93, 0},
{115, 98, 117, 0},
{102, 117, 101, 0},
{102, 113, 117, 0},
{113, 110, 109, 0},
{113, 102, 110, 0},
{109, 106, 113, 0},
{120, 113, 119, 0},
{113, 120, 121, 0},
{118, 122, 123, 0},
{122, 118, 115, 0},
{120, 122, 121, 0},
{122, 120, 123, 0},
{118, 120, 119, 0},
{120, 118, 123, 0},
{113, 122, 115, 0},
{122, 113, 121, 0},
};

static SVECTOR vader_norms[] = {
{3722, -1209, -1209, 0},
{-1461, -3255, 2011, 0},
{-3722, -1209, 1209, 0},
{0, -1209, 3913, 0},
{0, -1209, 3913, 0},
{-3722, -1209, 1209, 0},
{-2300, -1209, 3166, 0},
{3722, -1209, 1209, 0},
{-1461, -3255, 2011, 0},
{-2365, -3255, 768, 0},
{2365, -3255, -768, 0},
{2300, -1209, -3166, 0},
{-2300, -1209, -3166, 0},
{-2365, -3255, 768, 0},
{-2300, -1209, 3166, 0},
{2300, -1209, 3166, 0},
{0, -3255, 2486, 0},
{0, -3255, 2486, 0},
{-1461, -3255, -2011, 0},
{-2300, -1209, -3166, 0},
{1461, -3255, 2011, 0},
{2365, -3255, 768, 0},
{0, -1209, -3913, 0},
{0, -1209, -3913, 0},
{-3722, -1209, -1209, 0},
{2300, -1209, -3166, 0},
{-3722, -1209, -1209, 0},
{-2365, -3255, -768, 0},
{2300, -1209, 3166, 0},
{2365, -3255, -768, 0},
{1461, -3255, -2011, 0},
{0, -3255, -2486, 0},
{0, -3255, -2486, 0},
{-1461, -3255, -2011, 0},
{-2365, -3255, -768, 0},
{3722, -1209, 1209, 0},
{3722, -1209, -1209, 0},
{2365, -3255, 768, 0},
{1461, -3255, -2011, 0},
{0, -4096, 0, 0},
{0, -4096, 0, 0},
{0, -4096, 0, 0},
{0, -4096, 0, 0},
{0, -4096, 0, 0},
{0, -4096, 0, 0},
{0, -4096, 0, 0},
{0, -4096, 0, 0},
{1461, -3255, 2011, 0},
{-3640, -1456, 1182, 0},
{0, 4096, 0, 0},
{0, 4096, 0, 0},
{0, 4096, 0, 0},
{0, 4096, 0, 0},
{0, 4096, 0, 0},
{0, 4096, 0, 0},
{0, 4096, 0, 0},
{0, 4096, 0, 0},
{0, 4096, 0, 0},
{0, 4096, 0, 0},
{0, 4096, 0, 0},
{0, 4096, 0, 0},
{0, 4096, 0, 0},
{0, 4096, 0, 0},
{2250, -1456, -3096, 0},
{2250, -1456, -3097, 0},
{2250, -1456, -3096, 0},
{2250, -1456, -3096, 0},
{-2250, -1456, 3096, 0},
{0, -1456, -3828, 0},
{0, -1456, -3828, 0},
{0, -1456, -3828, 0},
{0, -1456, -3828, 0},
{2250, -1456, 3096, 0},
{0, -1456, 3828, 0},
{0, -1456, 3828, 0},
{-2250, -1456, 3096, 0},
{-3640, -1456, 1182, 0},
{2250, -1456, 3096, 0},
{3640, -1456, 1182, 0},
{-2250, -1456, -3096, 0},
{-2250, -1456, -3097, 0},
{-2250, -1456, -3096, 0},
{-2250, -1456, -3096, 0},
{3640, -1456, -1182, 0},
{3640, -1456, 1182, 0},
{3640, -1456, -1182, 0},
{2250, -1456, -3096, 0},
{2250, -1456, -3096, 0},
{2250, -1456, -3096, 0},
{2250, -1456, -3096, 0},
{-3640, -1456, -1182, 0},
{-2250, -1456, -3096, 0},
{-2250, -1456, -3096, 0},
{-2250, -1456, -3096, 0},
{-2250, -1456, -3096, 0},
{-3640, -1456, -1182, 0},
{1461, 3255, -2011, 0},
{1461, 3255, -2011, 0},
{1461, 3255, -2011, 0},
{1461, 3255, -2011, 0},
{1461, 3255, -2011, 0},
{2365, 3255, -768, 0},
{2365, 3254, -768, 0},
{2364, 3255, -768, 0},
{2365, 3255, -768, 0},
{3722, 1209, -1209, 0},
{3722, 1209, -1209, 0},
{3722, 1209, -1209, 0},
{3722, 1209, -1209, 0},
{2364, 3255, -768, 0},
{2365, 3255, -768, 0},
{2365, 3255, -768, 0},
{2300, 1209, -3166, 0},
{2300, 1209, -3166, 0},
{3722, 1209, -1209, 0},
{3722, 1209, -1209, 0},
{3722, 1209, -1209, 0},
{3722, 1209, -1209, 0},
{-2300, 1209, -3166, 0},
{-2300, 1209, -3166, 0},
{-3722, 1209, -1209, 0},
{-3722, 1209, -1209, 0},
{-3722, 1209, -1209, 0},
{-3722, 1209, -1209, 0},
{0, 4096, 0, 0},
{0, 4096, 0, 0},
{0, 4096, 0, 0},
{0, 4096, 0, 0},
{-2365, 3254, -768, 0},
{-2364, 3255, -768, 0},
{-2365, 3255, -768, 0},
{-2365, 3255, -768, 0},
{-3722, 1209, -1209, 0},
{-3722, 1209, -1209, 0},
{-3722, 1209, -1209, 0},
{-3722, 1209, -1209, 0},
{0, 3255, -2486, 0},
{0, 3255, -2486, 0},
{-2365, 3255, -768, 0},
{-2365, 3255, -768, 0},
{-2364, 3255, -768, 0},
{-1461, 3255, -2011, 0},
{-1461, 3255, -2011, 0},
{-1461, 3255, -2011, 0},
{-1461, 3255, -2011, 0},
{-1461, 3255, -2011, 0},
{-3895, -1265, 0, 0},
{-3895, -1265, 0, 0},
{0, 4096, 0, 0},
{0, 4096, 0, 0},
{-2407, -3313, 0, 0},
{-2407, -3313, 0, 0},
{-2407, -3313, 0, 0},
{0, 0, -4096, 0},
{0, 0, -4096, 0},
{0, 0, -4096, 0},
{0, 0, -4096, 0},
{0, 0, -4096, 0},
{0, 0, -4096, 0},
{0, 0, -4096, 0},
{0, 0, -4096, 0},
{0, 0, -4096, 0},
{-2407, 3313, 0, 0},
{-2407, 3313, 0, 0},
{-3895, 1265, 0, 0},
{-3895, 1265, 0, 0},
{2407, 3313, 0, 0},
{2407, 3313, 0, 0},
{2407, 3313, 0, 0},
{2407, 3313, 0, 0},
{2407, 3313, 0, 0},
{3895, 1265, 0, 0},
{3895, 1265, 0, 0},
{3895, 1265, 0, 0},
{3895, 1265, 0, 0},
{2407, -3313, 0, 0},
{2407, -3313, 0, 0},
{2407, -3313, 0, 0},
{-2407, 3313, 0, 0},
{-2407, 3313, 0, 0},
{-2407, 3313, 0, 0},
{-2407, 3313, 0, 0},
{-2407, 3313, 0, 0},
{2407, 3313, 0, 0},
{2407, 3313, 0, 0},
{3895, -1265, 0, 0},
{3895, -1265, 0, 0},
{0, 0, -4096, 0},
{0, 0, -4096, 0},
{0, 0, -4096, 0},
{0, 0, -4096, 0},
{0, 0, -4096, 0},
{0, 0, -4096, 0},
{0, 0, -4096, 0},
{0, 0, -4096, 0},
{0, 0, -4096, 0},
{-3895, 1265, 0, 0},
{-3895, 1265, 0, 0},
{0, 4096, 0, 0},
{0, 4096, 0, 0},
{0, 4096, 0, 0},
{0, 4096, 0, 0},
{-3408, -2272, 0, 0},
{-3408, -2272, 0, 0},
{0, 0, -4096, 0},
{3408, -2272, 0, 0},
{3408, -2272, 0, 0},
{3663, 1831, 0, 0},
{3663, 1831, 0, 0},
{3663, 1831, 0, 0},
{3663, 1831, 0, 0},
{-3663, 1831, 0, 0},
{-3663, 1831, 0, 0},
{-3663, 1831, 0, 0},
{-3663, 1831, 0, 0},
{0, 0, 4096, 0},
{0, 0, 4096, 0},
{0, 0, -4096, 0},
{0, 0, -4096, 0},
{0, 0, -4096, 0},
{0, 0, -4096, 0},
{0, 0, -4096, 0},
{0, 0, -4096, 0},
{0, 0, -4096, 0},
{0, 0, -4096, 0},
{0, 0, -4096, 0},
{0, 0, -4096, 0},
{0, 0, -4096, 0},
{0, 0, -4096, 0},
{0, 0, -4096, 0},
{0, 0, -4096, 0},
{0, 0, -4096, 0},
{0, 0, -4096, 0},
{0, 0, -4096, 0},
{-2896, -2896, 0, 0},
{-2896, -2896, 0, 0},
{2896, -2896, 0, 0},
{2896, -2896, 0, 0},
{0, 4096, 0, 0},
{0, 4096, 0, 0},
{0, 0, 4096, 0},
{0, 0, 4096, 0},
{0, 0, -4096, 0},
{0, 0, -4096, 0},
};


//local fontions
void init_scene06(){
	/* Set primitive pointer address */
	// new_primitive should do the job :)

	color_mtx.m[0][0]=ONE*1/4;
	color_mtx.m[1][0]=ONE*1/4;
	color_mtx.m[2][0]=ONE*1/4;
	
	color_mtx_2.m[0][0]=ONE*3/4;
	color_mtx_2.m[1][0]=0;
	color_mtx_2.m[2][0]=0;
	
	light_mtx.m[0][0]=0;
	light_mtx.m[0][1]=2048;
	light_mtx.m[0][2]=4096;
	
	//FntLoad(960, 0);
	//FntOpen(4, 140, 312, 64, 2, 256);
	
	/* Initialize the GTE */
	InitGeom();
	
	/* Set GTE offset (recommended method  of centering) */
	gte_SetGeomOffset( CENTERX, CENTERY );
	
	/* Set screen depth (basically FOV control, W/2 works best) */
	gte_SetGeomScreen( CENTERX );
	
	/* Set light ambient color and light color matrix */
	gte_SetBackColor( 16, 16, 16 );
	gte_SetColorMatrix( &color_mtx );
	
	nb_faces = sizeof(vader_indices) / sizeof(vader_indices[0]);
	curent_color = 1;
}

void make_so66(RenderContext *ctx, MATRIX mtx, MATRIX lmtx, VECTOR pos ,SVECTOR rot, int p){
	int i;
	
	/* Set rotation and translation to the matrix */
	RotMatrix( &rot, &mtx );
	TransMatrix( &mtx, &pos );
	
	/* Multiply light matrix by rotation matrix so light source */
	/* won't appear relative to the model's rotation */
	MulMatrix0( &light_mtx, &mtx, &lmtx );
	
	/* Set rotation and translation matrix */
	gte_SetRotMatrix( &mtx );
	gte_SetTransMatrix( &mtx );
	
	/* Set light matrix */
	gte_SetLightMatrix( &lmtx );
	
	//nb_faces = sizeof(so6_indices) / sizeof(so6_indices[0]);
	for(i=0; i<so6_faces;i++){
		
		//if(deathstar_indices[i].color != curent_color){
		//	gte_SetColorMatrix( &color_mtx_2 );
		//	curent_color=2;
		//}
		
		/* Load the first 3 vertices of a quad to the GTE */
		gte_ldv3( 
			&so6_verts[so6_indices[i].v0], 
			&so6_verts[so6_indices[i].v1], 
			&so6_verts[so6_indices[i].v2] );
			
		/* Rotation, Translation and Perspective Triple */
		gte_rtpt();
		
		/* Compute normal clip for backface culling */
		gte_nclip();
		
		/* Get result*/
		gte_stopz( &p );
		
		/* Skip this face if backfaced */
		if( p < 0 )
			continue;
		
		/* Calculate average Z for depth sorting */
		gte_avsz4();
		gte_stotz( &p );
		
		/* Skip if clipping off */
		/* (the shift right operator is to scale the depth precision) */
		if( (p>>2) > OT_LENGTH )
			continue;
		
		POLY_F3 *pol3 = (POLY_F3 *) new_primitive(ctx, p, sizeof(POLY_F3));
		
		/* Initialize a quad primitive */
		//setPolyFT4( pol3 );
		setPolyF3(pol3);
		
		/* Set the projected vertices to the primitive */
		gte_stsxy0( &pol3->x0 );
		gte_stsxy1( &pol3->x1 );
		gte_stsxy2( &pol3->x2 );
		
		/* Load primitive color even though gte_ncs() doesn't use it. */
		/* This is so the GTE will output a color result with the */
		/* correct primitive code. */
		gte_ldrgb( &pol3->r0 );
		
		/* Load the face normal */
		gte_ldv0( &so6_norms[i] );
		
		/* Normal Color Single */
		gte_ncs();
		
		/* Store result to the primitive */
		gte_strgb( &pol3->r0 );
		

	}
	
}

void make_vader(RenderContext *ctx, MATRIX mtx, MATRIX lmtx, VECTOR pos ,SVECTOR rot, int p){
	int i;
	
	/* Set rotation and translation to the matrix */
	RotMatrix( &rot, &mtx );
	TransMatrix( &mtx, &pos );
	
	/* Multiply light matrix by rotation matrix so light source */
	/* won't appear relative to the model's rotation */
	MulMatrix0( &light_mtx, &mtx, &lmtx );
	
	/* Set rotation and translation matrix */
	gte_SetRotMatrix( &mtx );
	gte_SetTransMatrix( &mtx );
	
	/* Set light matrix */
	gte_SetLightMatrix( &lmtx );
	
	nb_faces = sizeof(vader_indices) / sizeof(vader_indices[0]);
	for(i=0; i<nb_faces;i++){
		
		//if(deathstar_indices[i].color != curent_color){
		//	gte_SetColorMatrix( &color_mtx_2 );
		//	curent_color=2;
		//}
		
		/* Load the first 3 vertices of a quad to the GTE */
		gte_ldv3( 
			&vader_verts[vader_indices[i].v0], 
			&vader_verts[vader_indices[i].v1], 
			&vader_verts[vader_indices[i].v2] );
			
		/* Rotation, Translation and Perspective Triple */
		gte_rtpt();
		
		/* Compute normal clip for backface culling */
		gte_nclip();
		
		/* Get result*/
		gte_stopz( &p );
		
		/* Skip this face if backfaced */
		if( p < 0 )
			continue;
		
		/* Calculate average Z for depth sorting */
		gte_avsz4();
		gte_stotz( &p );
		
		/* Skip if clipping off */
		/* (the shift right operator is to scale the depth precision) */
		if( (p>>2) > OT_LENGTH )
			continue;
		
		POLY_F3 *pol3 = (POLY_F3 *) new_primitive(ctx, p, sizeof(POLY_F3));
		
		/* Initialize a quad primitive */
		//setPolyFT4( pol3 );
		setPolyF3(pol3);
		
		/* Set the projected vertices to the primitive */
		gte_stsxy0( &pol3->x0 );
		gte_stsxy1( &pol3->x1 );
		gte_stsxy2( &pol3->x2 );
		
		/* Load primitive color even though gte_ncs() doesn't use it. */
		/* This is so the GTE will output a color result with the */
		/* correct primitive code. */
		gte_ldrgb( &pol3->r0 );
		
		/* Load the face normal */
		gte_ldv0( &vader_norms[i] );
		
		/* Normal Color Single */
		gte_ncs();
		
		/* Store result to the primitive */
		gte_strgb( &pol3->r0 );
		

	}
	
}

void scene06_play(RenderContext ctx){
	
	int p,j;
	
	int time = 0;
	int playing = 1;
	
	int vertical[] = {-100,-50,50,-60,100,80};
	int horizontal[] = {-50,0,200,-100,50,-150};
	int profond[] = {-200,0,-150,-100,50,-150};
	SVECTOR rot_list[] ={{ 0 },{ 0 },{ 0 },{ 0 },{ 0 },{ 0 }};

	int x_vader = -768;

	setup_context(&ctx, SCREEN_XRES, SCREEN_YRES, 128, 128, 128);

	init_scene06();
	
	SVECTOR	rot = { 0 };			/* Rotation vector for Rotmatrix */
	SVECTOR	rot2 = { 0 };
	SVECTOR	rot3 = { 0 };
	SVECTOR	rot4 = { 0 };
	VECTOR	pos = { -768, -50, 500 };
	MATRIX	mtx,lmtx;				/* Rotation matrices for geometry and lighting */

	rot4.vx = 2048;
	//rot.vy = -256;
	rot4.vy = -192;
	rot.vx = 1024;
	
	gte_SetColorMatrix( &color_mtx );
	
	/* Main loop */
	while( playing>0 ) {
		time++;
		
		pos.vx = x_vader;
		pos.vy = -50;
		pos.vz = 500;
		
		
		//rot.vy += 4;
		//rot.vy = isin(time*4)/12;
		if(pos.vx<0){
			x_vader +=2;
			rot4.vy +=1;
		}
		pos.vx = x_vader;
		gte_SetColorMatrix( &color_mtx );
		make_vader(&ctx, mtx, lmtx, pos, rot4, p);
		
		gte_SetColorMatrix( &color_mtx_2 );
		if(pos.vx>=0){
			for (j=0;j<6;j++){
				pos.vy = vertical[j];
				pos.vx = horizontal[j];
				pos.vz = profond[j];
				if(pos.vy <450){
					make_so66(&ctx, mtx, lmtx, pos, rot_list[j], p);
				}
				if(profond[j]<280){
					profond[j]+=4;
					if(j%3==0){
						rot_list[j].vx -= 16;
						rot_list[j].vz += 16;
					}
					if(j%3==1){
						rot_list[j].vy += 8;
						rot_list[j].vz += 16;
					}
					if(j%3==2){
						rot_list[j].vx = 8*time;
						rot_list[j].vx = 16*time;
					}
				}else{
					if(rot_list[j].vx<0){rot_list[j].vx+=4096;}
					if(rot_list[j].vx%2048<1024){
						rot_list[j].vx+=16;
					}
					if(rot_list[j].vx%2048>1024){
						rot_list[j].vx-=16;
					}
					
					if(vertical[j]<500 &&
						(rot_list[j].vx%4096<1048 && rot_list[j].vx%4096>1000) ||
						(rot_list[j].vx%4096<3096 && rot_list[j].vx%4096>3048)
					){
						vertical[j]+=8;
						rot_list[j].vx =1024;
					}
				}
				//FntPrint(-1, "angle %02d: %02d\n",j, pos.vy);
			}
		}
		
		
		//FntFlush(-1);
		
		if(MOD_CurrentPattern == 0){
			playing = 0;
		}else{
			flip_buffers(&ctx);
			checkMusic();
		}

		
	}

}